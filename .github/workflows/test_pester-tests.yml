name: Pester Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout

      - name: Set up PowerShell
        run: |
          echo "Installing PowerShell Core..."
          sudo apt-get update
          sudo apt-get install -y powershell
          pwsh --version

      - name: Install Pester
        run: pwsh -command "Install-Module -Name Pester -Force -SkipPublisherCheck"

      - name: Run Pester tests
        run: |
          mkdir -p test-results
          pwsh -command "Invoke-Pester -Path ./tests -OutputFormat NUnitXml -OutputFile ./test-results/test-results.xml"

      - name: Publish test results
        uses: actions/upload-artifact
        with:
          name: test-results
          path: ./test-results/test-results.xml

      - name: Display test results
        if: always()
        uses: dorny/test-reporter
        with:
          name: Pester Tests
          path: ./test-results/test-results.xml
          reporter: nunit